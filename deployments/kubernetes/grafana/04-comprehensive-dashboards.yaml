apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-comprehensive
  namespace: mytsdb
  labels:
    app: grafana
data:
  00-k8s-seeded-cluster.json: |
    {
      "title": "MyTSDB K8s Seeded Cluster (Arrow, ~20M)",
      "tags": ["mytsdb", "k8s", "seeded", "arrow"],
      "timezone": "browser",
      "schemaVersion": 38,
      "version": 1,
      "refresh": "30s",
      "time": {"from": "now-7d", "to": "now"},
      "templating": {
        "list": [
          {
            "name": "region",
            "type": "query",
            "datasource": "MyTSDB",
            "query": "label_values(container_cpu_usage_seconds_total, region)",
            "refresh": 2,
            "includeAll": true,
            "multi": true,
            "allValue": ".*"
          },
          {
            "name": "zone",
            "type": "query",
            "datasource": "MyTSDB",
            "query": "label_values(container_cpu_usage_seconds_total, zone)",
            "refresh": 2,
            "includeAll": true,
            "multi": true,
            "allValue": ".*"
          },
          {
            "name": "cluster",
            "type": "query",
            "datasource": "MyTSDB",
            "query": "label_values(container_cpu_usage_seconds_total, cluster)",
            "refresh": 2,
            "includeAll": true,
            "multi": true,
            "allValue": ".*"
          },
          {
            "name": "namespace",
            "type": "query",
            "datasource": "MyTSDB",
            "query": "label_values(container_cpu_usage_seconds_total, namespace)",
            "refresh": 2,
            "includeAll": true,
            "multi": true,
            "allValue": ".*"
          },
          {
            "name": "service",
            "type": "query",
            "datasource": "MyTSDB",
            "query": "label_values(container_cpu_usage_seconds_total, service)",
            "refresh": 2,
            "includeAll": true,
            "multi": true,
            "allValue": ".*"
          },
          {
            "name": "node",
            "type": "query",
            "datasource": "MyTSDB",
            "query": "label_values(node_cpu_seconds_total, node)",
            "refresh": 2,
            "includeAll": true,
            "multi": true,
            "allValue": ".*"
          },
          {
            "name": "pod",
            "type": "query",
            "datasource": "MyTSDB",
            "query": "label_values(container_cpu_usage_seconds_total, pod)",
            "refresh": 2,
            "includeAll": true,
            "multi": true,
            "allValue": ".*"
          }
        ]
      },
      "panels": [
        {
          "id": 0,
          "title": "üîç TEST: Simple Metric Count",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
          "targets": [{"expr": "count(container_cpu_usage_seconds_total)", "refId": "A"}],
          "description": "Test query: Count of container_cpu_usage_seconds_total series. Should show ~5000 (50 pods * 100 metrics)."
        },
        {
          "id": 1,
          "title": "üîç TEST: Sample Data Point",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
          "targets": [{"expr": "last_over_time(container_cpu_usage_seconds_total[1h])", "refId": "A"}],
          "description": "Test query: Get latest value of container_cpu_usage_seconds_total. Should show a numeric value."
        },
        {
          "id": 2,
          "title": "üîç TEST: Time Series Data",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
          "targets": [{"expr": "container_cpu_usage_seconds_total", "refId": "A", "legendFormat": "{{pod}}"}],
          "description": "Test query: Show raw container_cpu_usage_seconds_total time series. Should display lines over 7 days."
        },
        {
          "id": 3,
          "title": "üîç TEST: Rate Calculation",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
          "targets": [{"expr": "rate(container_cpu_usage_seconds_total[15m])", "refId": "A", "legendFormat": "{{pod}}"}],
          "description": "Test query: Calculate rate of container_cpu_usage_seconds_total. Should show CPU usage rate per second."
        },
        {
          "id": 4,
          "title": "Pods Up",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 12},
          "targets": [{"expr": "count(container_cpu_usage_seconds_total)", "refId": "A"}]
        },
        {
          "id": 5,
          "title": "Series Cardinality (approx via label values)",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 6, "y": 12},
          "targets": [{"expr": "count({__name__=~\"container_.+\"})", "refId": "A"}]
        },
        {
          "id": 6,
          "title": "Container CPU (by namespace)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
          "targets": [
            {
              "expr": "sum(rate(container_cpu_usage_seconds_total{region=~\"$region\",zone=~\"$zone\",cluster=~\"$cluster\",namespace=~\"$namespace\"}[15m])) by (namespace)",
              "legendFormat": "{{namespace}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 7,
          "title": "Container Memory Working Set (by namespace)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
          "targets": [
            {
              "expr": "sum(container_memory_working_set_bytes{region=~\"$region\",zone=~\"$zone\",cluster=~\"$cluster\",namespace=~\"$namespace\"}) by (namespace)",
              "legendFormat": "{{namespace}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 8,
          "title": "Top 10 CPU Pods",
          "type": "bargauge",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
          "targets": [
            {
              "expr": "topk(10, sum(rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\",service=~\"$service\"}[15m])) by (pod))",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 9,
          "title": "Top 10 Memory Pods",
          "type": "bargauge",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
          "targets": [
            {
              "expr": "topk(10, sum(container_memory_working_set_bytes{namespace=~\"$namespace\",service=~\"$service\"}) by (pod))",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 10,
          "title": "Node CPU Usage Rate",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32},
          "targets": [
            {
              "expr": "avg(rate(node_cpu_seconds_total[15m])) by (node)",
              "legendFormat": "{{node}}",
              "refId": "A"
            }
          ],
          "description": "Average CPU usage rate per second by node. Note: node_cpu_seconds_total is a counter, so this shows the rate of increase."
        },
        {
          "id": 11,
          "title": "Node Memory Used (%)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32},
          "targets": [
            {
              "expr": "(1 - (node_memory_MemAvailable_bytes{node=~\"$node\"} / node_memory_MemTotal_bytes{node=~\"$node\"})) * 100",
              "legendFormat": "{{node}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 12,
          "title": "Network RX (containers)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 40},
          "targets": [
            {
              "expr": "sum(rate(container_network_receive_bytes_total{namespace=~\"$namespace\",service=~\"$service\"}[15m])) by (pod)",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 13,
          "title": "Network TX (containers)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 40},
          "targets": [
            {
              "expr": "sum(rate(container_network_transmit_bytes_total{namespace=~\"$namespace\",service=~\"$service\"}[15m])) by (pod)",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 14,
          "title": "Filesystem Reads (containers)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 48},
          "targets": [
            {
              "expr": "sum(rate(container_fs_reads_bytes_total{namespace=~\"$namespace\",service=~\"$service\"}[15m])) by (pod)",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 15,
          "title": "Filesystem Writes (containers)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 48},
          "targets": [
            {
              "expr": "sum(rate(container_fs_writes_bytes_total{namespace=~\"$namespace\",service=~\"$service\"}[15m])) by (pod)",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 16,
          "title": "HTTP RPS (by service)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 56},
          "targets": [
            {
              "expr": "sum(rate(http_requests_total{namespace=~\"$namespace\"}[15m])) by (service)",
              "legendFormat": "{{service}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 17,
          "title": "HTTP Latency p99 (by service)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 56},
          "targets": [
            {
              "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[15m])) by (le, service))",
              "legendFormat": "{{service}}",
              "refId": "A"
            }
          ],
          "description": "99th percentile HTTP request latency using histogram_quantile. Requires histogram buckets with 'le' label."
        },
        {
          "id": 18,
          "title": "Kube Pod Phase (count by phase)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 64},
          "targets": [
            {
              "expr": "count(kube_pod_status_phase{namespace=~\"$namespace\"}) by (phase)",
              "legendFormat": "{{phase}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 19,
          "title": "Restarts (1h increase)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 64},
          "targets": [
            {
              "expr": "sum(increase(kube_pod_container_status_restarts_total{namespace=~\"$namespace\"}[1h])) by (namespace)",
              "legendFormat": "{{namespace}}",
              "refId": "A"
            }
          ]
        }
      ]
    }

  01-cluster-overview.json: |
    {
      "title": "Cluster Overview",
      "tags": ["mytsdb", "cluster", "overview"],
      "timezone": "browser",
      "panels": [
        {
          "id": 1,
          "title": "Cluster Health (Up)",
          "type": "stat",
          "gridPos": {"h": 4, "w": 24, "x": 0, "y": 0},
          "targets": [{"expr": "sum(up)", "legendFormat": "Total Pods Up"}]
        },
        {
          "id": 2,
          "title": "Node CPU Usage Ratio",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
          "targets": [{"expr": "node_cpu_usage_ratio", "legendFormat": "{{node}} - {{zone}}"}]
        },
        {
          "id": 3,
          "title": "Node Memory Usage Ratio",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
          "targets": [{"expr": "node_memory_usage_ratio", "legendFormat": "{{node}}"}]
        },
        {
          "id": 4,
          "title": "Top 5 CPU Consumers (Pods)",
          "type": "bar-gauge",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
          "targets": [{"expr": "topk(5, container_cpu_usage_ratio)", "legendFormat": "{{pod}}"}]
        },
        {
          "id": 5,
          "title": "Top 5 Memory Consumers (Pods)",
          "type": "bar-gauge",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
          "targets": [{"expr": "topk(5, process_resident_memory_bytes)", "legendFormat": "{{pod}}"}]
        }
      ],
      "refresh": "10s",
      "time": {"from": "now-1h", "to": "now"}
    }

  02-pod-performance.json: |
    {
      "title": "Pod Performance",
      "tags": ["mytsdb", "pod", "performance"],
      "timezone": "browser",
      "panels": [
        {
          "id": 1,
          "title": "HTTP Request Rate (Per Service)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "targets": [{"expr": "sum(rate(http_requests_total[5m])) by (service)", "legendFormat": "{{service}}"}]
        },
        {
          "id": 2,
          "title": "HTTP Request Rate (Per Pod)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "targets": [{"expr": "rate(http_requests_total[5m])", "legendFormat": "{{pod}}"}]
        },
        {
          "id": 3,
          "title": "99th Percentile Latency",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8},
          "targets": [{"expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service))", "legendFormat": "{{service}}"}]
        },
        {
          "id": 4,
          "title": "Average Latency",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 16},
          "targets": [{"expr": "rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])", "legendFormat": "{{service}}"}]
        }
      ],
      "refresh": "10s",
      "time": {"from": "now-1h", "to": "now"}
    }

  03-promql-playground.json: |
    {
      "title": "PromQL Playground",
      "tags": ["mytsdb", "promql", "advanced"],
      "timezone": "browser",
      "panels": [
        {
          "id": 1,
          "title": "Rate vs IRate (Traffic)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "targets": [
            {"expr": "rate(http_requests_total[5m])", "legendFormat": "rate 5m"},
            {"expr": "irate(http_requests_total[5m])", "legendFormat": "irate 5m"}
          ]
        },
        {
          "id": 2,
          "title": "Derivative of CPU Usage",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "targets": [{"expr": "deriv(container_cpu_usage_ratio[5m])", "legendFormat": "deriv {{pod}}"}]
        },
        {
          "id": 3,
          "title": "Linear Prediction (Memory Usage next 1h)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
          "targets": [
            {"expr": "process_resident_memory_bytes", "legendFormat": "Actual"},
            {"expr": "predict_linear(process_resident_memory_bytes[1h], 3600)", "legendFormat": "Predicted"}
          ]
        },
        {
          "id": 4,
          "title": "Aggregations (CPU)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
          "targets": [
            {"expr": "avg(container_cpu_usage_ratio)", "legendFormat": "Avg"},
            {"expr": "max(container_cpu_usage_ratio)", "legendFormat": "Max"},
            {"expr": "min(container_cpu_usage_ratio)", "legendFormat": "Min"},
            {"expr": "quantile(0.95, container_cpu_usage_ratio)", "legendFormat": "P95"}
          ]
        },
        {
          "id": 5,
          "title": "Changes (Resets)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
          "targets": [{"expr": "changes(up[1h])", "legendFormat": "Changes in Up status"}]
        },
        {
          "id": 6,
          "title": "Delta (Requests last 1h)",
          "type": "bar-gauge",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
          "targets": [{"expr": "delta(http_requests_total[1h])", "legendFormat": "{{pod}}"}]
        }
      ],
      "refresh": "10s",
      "time": {"from": "now-1h", "to": "now"}
    }
